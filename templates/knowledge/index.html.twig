{% extends 'base.html.twig' %}

{% block title %}Kip - {{ filename }}{% endblock %}
    {% block right %}
        <ul class="nav flex-column">
            <li class="nav-link">
                {{ filename }}
            </li>
            <li class="nav-link">
                <a href="#top"><i class="fad fa-arrow-up"></i> Scroll to top</a>
                <a class="btn btn-primary" href="#" onclick="openEditor()"><i class="fad fa-edit"></i> Edit</a>
                <a class="btn btn-danger" href="{{ path('documents_delete',{path:filename}) }}" onclick="confirm('are you sure?')"><i class="fad fa-trash"></i> Delete</a>
            </li>
            {% for item in table %}
                <li class="nav-link" style="font-size: {{ 5+(7-item.level)*2 }}px;">
                    {% for i in range(1, item.level) %}#{% endfor %}

                    <a href="#{{ item.id }}">
                        {{ item.text }}
                    </a>
                </li>
            {% endfor %}
        </ul>
    {% endblock %}

{% block body %}
    {% if content|length ==0 %}
        <h1>404 - File Empty or not found!</h1>
        <p>This file seems empty/inexistant, but don't worry and start <a href="#" onclick="openEditor()">Edit it</a>
        </p>
    {% endif %}
    <div class="page-content">
    {{ content|raw }}
    </div>


{% endblock %}

{% block javascripts %}
    <script src="https://unpkg.com/stackedit-js@1.0.7/docs/lib/stackedit.min.js"></script>
    <textarea style="display: none;">{{ raw }}</textarea>
    <script>
        const stackedit = new Stackedit();
        const el = document.querySelector('textarea');

        function openEditor() {
            // Open the iframe
            stackedit.openFile({
                name: '{{ filename }}', // with an optional filename
                content: {
                    text: el.value // and the Markdown content.
                }
            });
            setInterval(function () {
                save(el.value, function (ok) {
                    if (!ok) {

                        alert("auto save failed!");
                    }

                })
            }, 20000);
        }


        stackedit.on('fileChange', (file) => {
            el.value = file.content.text
        });
        stackedit.on('close', () => {
            save(el.value, function (ok) {
                if (ok) {
                    location.reload()
                } else {
                    alert("an error occured, reopen the editor to save again.");
                }

            })

        });

        function save(content, callback) {
            let xhr = new XMLHttpRequest();
            xhr.open("PUT", "{{ path('documents_store',{path: filename}) }}");
            xhr.send(content);
            xhr.onload = function () {
                callback(xhr.status < 300 && xhr.status > 199);
            };
        }


    </script>
{% endblock %}